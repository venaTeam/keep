workflow:
  id: tiered-login-failure-response
  name: Tiered Login Failure Response
  description: Handles user login failures by querying customer tier from MySQL and routes notifications to appropriate channels - Slack for enterprise customers and Slack for all tiers.
  triggers:
    - type: alert
      filters:
        - key: name
          value: "User failed to login"
  steps:
    - name: get-customer-tier-by-id
      provider:
        type: mysql
        config: "{{ providers.mysql-prod }}"
        with:
          query: "SELECT customer_name, tier FROM customers WHERE customer_id = {{ alert.customer_id }} LIMIT 1"
  actions:
    # for enterprise customer, send a slack message with higher priority
    - name: slack-enterprise-alert
      condition:
        - name: enterprise-tier
          type: assert
          assert: "{{ steps.get-customer-tier-by-id.result.tier }} == 'enterprise'"
      provider:
        type: slack
        config: " {{ providers.slack-prod }} "
        with:
          message: "ðŸš¨ ENTERPRISE ALERT: User of customer {{ steps.get-customer-tier-by-id.result.customer_name }} failed to login!"
    # for every customer, send a slack message
    - name: trigger-slack
      provider:
        type: slack
        config: " {{ providers.slack-prod }} "
        with:
          message: "User of customer {{ steps.get-customer-tier-by-id.result.customer_name }} failed to login!"
